;(function($){$.fn.treeGrid=function(method){if(methods[method]){return methods[method].apply(this,Array.prototype.slice.call(arguments,1))}else{if(typeof method==="object"||!method){return methods.init.apply(this,arguments)}else{$.error("Method "+method+" does not exist on jQuery.treeGrid")}}};$.fn.treeGrid.options=undefined;var methods={init:function(_options){return this.each(function(){var $this=$(this);var args=$.extend({},$.fn.treeGrid.defaults,_options);$.fn.treeGrid.options=args;var datas=args.data;var colModel=args.colModel;var treeReader=args.treeReader;var selected=args.selected.split(",");var single=args.single;var showNav=args.showNav;var cascade=args.cascade;if(datas.length<1){if(args.url){var url=args.url;var method=args.method;$.ajax({type:method,url:url,data:"_="+new Date(),async:false,success:function(data){datas=data},error:function(){alert("加载数据失败")}})}else{alert("加载数据失败");return false}}var $table=$(this);var name,value,title,formatter,witdh,$tr,$td;if(showNav){$tr=$("<tr>").append($("<td>").append($("<button>").addClass("btn").addClass("btn-xs").addClass("btn-purple").attr("id","selectAll").text("全选")).append($("<button>").addClass("btn").addClass("btn-xs").addClass("btn-grey").attr("id","selectNone").text("全不选")).append($("<button>").addClass("btn").addClass("btn-xs").addClass("btn-purple").attr("id","expandAll").text("展开全部")).append($("<button>").addClass("btn").addClass("btn-xs").addClass("btn-grey").attr("id","collapseAll").text("折叠全部")).attr("colspan",colModel.length+1));$table.append($tr)}$tr=$("<tr>").append($("<th>"));$.each(colModel,function(c,m){$tr.append($("<th>").text(m["title"]))});$table.append($tr);var maxLevel=0;$.each(datas,function(i,data){maxLevel=maxLevel<parseInt(data[treeReader["level"]])?parseInt(data[treeReader["level"]]):maxLevel;$tr=$("<tr>").addClass("treegrid-"+data[treeReader.id]).attr("id","node_"+data[treeReader.id]);if(parseInt(data[treeReader.pid])>0){$tr.addClass("treegrid-parent-"+data[treeReader.pid]).attr("pid",data[treeReader.pid])}if(single){$td=$("<td>").css("width",(maxLevel+1)*24+"px").append($("<input type='radio' name='tree_radio_id' value='"+data[treeReader.id]+"'>").addClass("tree_check"))}else{$td=$("<td>").css("width",(maxLevel+1)*24+"px").append($("<input type='checkbox'>").addClass("tree_check"))}if(selected.indexOf(data[treeReader.id])>-1){$td.find(".tree_check").prop("checked",true)}$tr.append($td);$.each(colModel,function(c,m){title=m["title"]||"";formatter=m["formatter"];value=data[m["name"]];width=m["width"];if(formatter){value=formatter.call(this,value)}$td=$("<td>").attr("title",title).text(value);if(width){$td.css("width",width+"px")}$tr.append($td)});$table.append($tr)});$table.treegrid();if(!single){$table.find(".tree_check").click(function(){var $node=$(this);$.each($node.parent().parent().treegrid("getAllChildNodes"),function(){$(this).find(".tree_check").prop("checked",$node.is(":checked"))});if(cascade){loopCheck($node,$node.is(":checked"))}});$table.find("#selectAll").click(function(){$table.find("input[type='checkbox']").prop("checked",true)});$table.find("#selectNone").click(function(){$table.find("input[type='checkbox']").prop("checked",false)});$table.find("#expandAll").click(function(){$table.treegrid("expandAll")});$table.find("#collapseAll").click(function(){$table.treegrid("collapseAll")})}function loopCheck(node,isChecked,pid){var $c=$(node);var $p=pid?$(".treegrid-"+pid):$c.parent().parent();var pid=$p.attr("pid");var isRoot=$p.hasClass("treegrid-expanded");if(!isChecked){var i=0;$p.treegrid("getAllChildNodes").each(function(){var $t=$(this);$t.find(":checked").each(function(){if($(this).is(":checked")){i++}})});if(i<1){$p.find(".tree_check").prop("checked",isChecked)}}else{$p.find(".tree_check").prop("checked",isChecked)}if(!isRoot||pid){loopCheck($p,isChecked,pid)}}})},getAllSelectNodesId:function(){var ids=new Array();var $table=$(this);var options=$.fn.treeGrid.options;if(!options.single){$.each($table.find(":checkbox"),function(i,d){if($(this).prop("checked")){ids.push($(this).parent().parent().attr("id").replace("node_",""))}});return ids.join(",")}else{return $table.find(":checked").attr("value")}}};$.fn.treeGrid.defaults={colModel:[],treeReader:{"id":"id","pid":"pid","level":"level"},data:[],url:"",method:"POST",selected:"",single:false,showNav:true,cascade:false,}})(jQuery);